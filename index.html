<!doctype html>
<html lang="ja">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>YT Mini Mixer (Practice)</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 10px; }
  .deck { border: 1px solid #ccc; border-radius: 12px; padding: 10px; margin-bottom: 10px; }
  .row { display:flex; gap:8px; align-items:center; margin:6px 0; }
  .col { flex:1 }
  .big { width:100%; }
  #xfader { width:100%; }
  button, input[type=range] { touch-action: manipulation; }
</style>
<body>
<h1>YT Mini Mixer</h1>

<div class="row"><button id="arm">Arm(準備)</button><button id="playBoth">Play</button><button id="pauseBoth">Pause</button></div>
<div class="deck" id="playlistBox">
  <h3>Playlist Loader</h3>
  <div class="row">
    <input id="playlistInput" class="col" placeholder="プレイリストID または URL">
    <button id="loadPlaylistBtn">Load Playlist</button>
  </div>
  <div class="row">
    <select id="playlistSelect" class="big"></select>
  </div>
  <div class="row">
    <button id="assignToA">← Set to Deck A</button>
    <button id="assignToB">Set to Deck B →</button>
  </div>
  <div id="playlistMeta" style="font-size:12px;color:#666"></div>
  <div id="hiddenLoader" style="display:none"></div>
  <small>プレイリストを読み込むと一覧に表示されます。選択してA/Bに割り当ててください。</small>
  <hr>
</div>
<div class="row"><label class="col">Crossfader</label><input id="xfader" type="range" min="0" max="100" value="50"></div>

<div class="deck" id="deckA">
  <h3>Deck A</h3>
  <div class="row">
    <input id="vidA" class="col" placeholder="動画ID or プレイリストID">
    <select id="modeA"><option value="video">video</option><option value="playlist">playlist</option></select>
    <button id="loadA">Load</button>
  </div>
  <div id="playerA"></div>
  <div class="row">
    <button id="playA">Play</button><button id="pauseA">Pause</button>
    <input id="volA" type="range" min="0" max="100" value="80">
    <span id="timeA">0.0s</span>
  </div>
  <div class="row">
    <button data-jog="-0.2">⟲ -0.2s</button><button data-jog="0.2">⟳ +0.2s</button>
  </div>
</div>

<div class="deck" id="deckB">
  <h3>Deck B</h3>
  <div class="row">
    <input id="vidB" class="col" placeholder="動画ID or プレイリストID">
    <select id="modeB"><option value="video">video</option><option value="playlist">playlist</option></select>
    <button id="loadB">Load</button>
  </div>
  <div id="playerB"></div>
  <div class="row">
    <button id="playB">Play</button><button id="pauseB">Pause</button>
    <input id="volB" type="range" min="0" max="100" value="80">
    <span id="timeB">0.0s</span>
  </div>
  <div class="row">
    <button data-jogB="-0.2">⟲ -0.2s</button><button data-jogB="0.2">⟳ +0.2s</button>
  </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let playerA, playerB, armed = false;
// 入力文字列から動画ID/プレイリストIDを抽出（URLも許容）
function parseVideoId(input){
  const s = (input||'').trim();
  if(!s) return null;
  try {
    const u = new URL(s);
    // https://www.youtube.com/watch?v=VIDEOID
    const v = u.searchParams.get('v');
    if(v) return v;
    // https://youtu.be/VIDEOID
    if(u.hostname.includes('youtu.be')){
      const p = u.pathname.split('/').filter(Boolean);
      if(p[0]) return p[0];
    }
    // https://www.youtube.com/shorts/VIDEOID or /embed/VIDEOID
    const m = u.pathname.match(/\/(shorts|embed)\/([\w-]{11})/);
    if(m) return m[2];
  } catch(e) {}
  // 11桁のIDらしきものを抽出
  const m = s.match(/[\w-]{11}/);
  return m ? m[0] : null;
}
function parsePlaylistId(input){
  const s = (input||'').trim();
  if(!s) return null;
  try {
    const u = new URL(s);
    const list = u.searchParams.get('list');
    if(list) return list;
  } catch(e) {}
  return s; // そのままIDとみなす
}
function handlePlayerError(which, e){
  const code = e && typeof e.data === 'number' ? e.data : -1;
  let msg = '不明なエラー';
  if(code===2) msg='ID/URLが不正です（形式/文字種）';
  else if(code===5) msg='HTML5プレーヤーエラー（別動画で再試行）';
  else if(code===100) msg='動画が削除/非公開の可能性';
  else if(code===101 || code===150) msg='この動画は外部サイトでの再生が許可されていません（埋め込み不可）';
  alert(`Deck ${which}: 再生エラー(${code}) - ${msg}`);
  try { console.error('YouTube Player Error', which, e); } catch(_) {}
}
function onYouTubeIframeAPIReady() {
  playerA = new YT.Player('playerA', { height:'180', width:'320',
    playerVars:{ playsinline:1, enablejsapi:1, origin:location.origin },
    events:{ 'onReady': onReadyA, 'onError': e=>handlePlayerError('A', e) }});
  playerB = new YT.Player('playerB', { height:'180', width:'320',
    playerVars:{ playsinline:1, enablejsapi:1, origin:location.origin },
    events:{ 'onReady': onReadyB, 'onError': e=>handlePlayerError('B', e) }});
}
function onReadyA(){ playerA.setVolume(80); }
function onReadyB(){ playerB.setVolume(80); }

document.getElementById('arm').onclick = () => {
  // iOS向け：ユーザー操作で一度mute再生→準備完了後に停止
  [playerA, playerB].forEach(p => { try { p.mute(); p.playVideo(); setTimeout(()=>p.pauseVideo(), 200); } catch(e){} });
  armed = true;
  alert('Armed: 以降の再生が安定します');
};

// Playlist Loader: プレイリスト読み込み→一覧選択→A/Bへ割当
let hiddenPlaylistPlayer = null;
let currentPlaylistIds = [];
function buildSelectOptions(){
  const sel = document.getElementById('playlistSelect');
  sel.innerHTML = '';
  currentPlaylistIds.forEach((id, idx)=>{
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = `${idx+1}. ${id}`;
    sel.appendChild(opt);
  });
}
function fetchVideoTitle(videoId){
  // oEmbedでタイトル取得（キー不要）。失敗してもIDを表示
  return fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`)
    .then(r=> r.ok ? r.json() : null)
    .then(d=> d ? d.title : null)
    .catch(()=> null);
}
function updateSelectTitles(){
  const sel = document.getElementById('playlistSelect');
  [...sel.options].forEach((opt, i)=>{
    const vid = opt.value;
    fetchVideoTitle(vid).then(title=>{
      if(title) opt.textContent = `${i+1}. ${title}`;
    });
  });
}
function onHiddenPlaylistReady(){
  try { hiddenPlaylistPlayer.setShuffle(false); } catch(e){}
}
function loadPlaylistToHidden(listId){
  if(!hiddenPlaylistPlayer){
    hiddenPlaylistPlayer = new YT.Player('hiddenLoader', {
      height:'0', width:'0', playerVars:{ playsinline:1, listType:'playlist', list:listId },
      events:{
        'onReady': onHiddenPlaylistReady,
        'onStateChange': ()=>{
          try {
            const playlist = hiddenPlaylistPlayer.getPlaylist();
            if(Array.isArray(playlist) && playlist.length){
              currentPlaylistIds = playlist;
              buildSelectOptions();
              updateSelectTitles();
            }
          } catch(e){}
        }
      }
    });
  } else {
    try { hiddenPlaylistPlayer.loadPlaylist({ listType:'playlist', list:listId }); } catch(e){}
  }
}
document.getElementById('loadPlaylistBtn').onclick = ()=>{
  const raw = document.getElementById('playlistInput').value.trim();
  const listId = parsePlaylistId(raw);
  if(!listId){ alert('プレイリストID/URLを認識できません'); return; }
  currentPlaylistIds = [];
  buildSelectOptions();
  document.getElementById('playlistMeta').textContent = `Loading playlist: ${listId}`;
  loadPlaylistToHidden(listId);
};
document.getElementById('assignToA').onclick = ()=>{
  const sel = document.getElementById('playlistSelect');
  const vid = sel.value;
  if(!vid){ alert('動画を選択してください'); return; }
  try { playerA.loadVideoById(vid); } catch(e){}
};
document.getElementById('assignToB').onclick = ()=>{
  const sel = document.getElementById('playlistSelect');
  const vid = sel.value;
  if(!vid){ alert('動画を選択してください'); return; }
  try { playerB.loadVideoById(vid); } catch(e){}
};

function loadDeck(idInput, modeSel, player){
  const raw = idInput.value.trim();
  if(!raw) return;
  if(modeSel.value === 'playlist'){
    const listId = parsePlaylistId(raw);
    if(!listId){ alert('プレイリストID/URLを認識できません'); return; }
    player.loadPlaylist({listType:'playlist', list:listId});
  } else {
    const vid = parseVideoId(raw);
    if(!vid){ alert('動画ID/URLを認識できません'); return; }
    player.loadVideoById(vid);
  }
}
document.getElementById('loadA').onclick = ()=> loadDeck(vidA, modeA, playerA);
document.getElementById('loadB').onclick = ()=> loadDeck(vidB, modeB, playerB);

document.getElementById('playBoth').onclick = ()=>{
  if(!armed) alert('先にArmを押してください');
  playerA.playVideo(); playerB.playVideo();
};
document.getElementById('pauseBoth').onclick = ()=>{ playerA.pauseVideo(); playerB.pauseVideo(); };
document.getElementById('playA').onclick = ()=> playerA.playVideo();
document.getElementById('pauseA').onclick = ()=> playerA.pauseVideo();
document.getElementById('playB').onclick = ()=> playerB.playVideo();
document.getElementById('pauseB').onclick = ()=> playerB.pauseVideo();

volA.oninput = e => playerA.setVolume(+e.target.value);
volB.oninput = e => playerB.setVolume(+e.target.value);

// クロスフェーダー（等電力的カーブ）
xfader.oninput = e => {
  const x = +e.target.value / 100; // 0..1
  const volA = Math.cos(Math.PI/2 * x);
  const volB = Math.cos(Math.PI/2 * (1-x));
  playerA.setVolume(Math.round(volA*100));
  playerB.setVolume(Math.round(volB*100));
};

// 簡易ジョグ
function jog(player, delta){ try {
  const t = player.getCurrentTime ? player.getCurrentTime() : 0;
  player.seekTo(Math.max(0, t + delta), true);
} catch(e){} }
document.querySelector('[data-jog="-0.2"]').onclick = ()=> jog(playerA, -0.2);
document.querySelector('[data-jog="0.2"]').onclick  = ()=> jog(playerA,  0.2);
document.querySelector('[data-jogB="-0.2"]').onclick= ()=> jog(playerB, -0.2);
document.querySelector('[data-jogB="0.2"]').onclick = ()=> jog(playerB,  0.2);

// 簡易タイマー表示
setInterval(()=>{
  try { timeA.textContent = playerA.getCurrentTime().toFixed(1)+'s'; }catch(e){}
  try { timeB.textContent = playerB.getCurrentTime().toFixed(1)+'s'; }catch(e){}
}, 200);
</script>
</body>
</html>
